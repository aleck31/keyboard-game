// Â∫îÁî®Â∑•ÂÖ∑ÁªÑ‰ª∂ - ÂèÇËÄÉÂéüUIManagerÂÆûÁé∞
const AppUtils = {
    name: 'AppUtils',
    setup() {
        const { ref, onMounted, onUnmounted } = Vue;
        
        // ÂΩìÂâç‰∏ªÈ¢òÁä∂ÊÄÅ
        const currentTheme = ref('dark');
        
        // ‰∏ªÈ¢òÈÖçÁΩÆ - ÂèÇËÄÉÂéüUIManagerÂÆûÁé∞
        const themes = ['dark', 'light', 'blue', 'green', 'purple'];
        const themeIcons = {
            dark: 'üåô',
            light: '‚òÄÔ∏è',
            blue: 'üåä',
            green: 'üåø',
            purple: 'üîÆ'
        };
        
        // Ëé∑Âèñ‰∏ªÈ¢ò‰∏≠ÊñáÂêçÁß∞
        const getThemeName = (theme) => {
            const themeNames = {
                dark: 'ÊöóËâ≤',
                light: '‰∫ÆËâ≤',
                blue: 'ËìùËâ≤',
                green: 'ÁªøËâ≤',
                purple: 'Á¥´Ëâ≤'
            };
            return themeNames[theme] || 'Êú™Áü•';
        };
        
        // ÊàêÂ∞±ÊòæÁ§∫
        const showAchievement = (achievement) => {
            const achievementEl = document.createElement('div');
            achievementEl.className = 'achievement-popup';
            achievementEl.innerHTML = `
                <div class="achievement-icon">${achievement.icon}</div>
                <div class="achievement-content">
                    <div class="achievement-title">üéâ ÊàêÂ∞±Ëß£ÈîÅÔºÅ</div>
                    <div class="achievement-name">${achievement.name}</div>
                    <div class="achievement-description">${achievement.description}</div>
                </div>
            `;
            
            // Ê∑ªÂä†Ê†∑Âºè
            Object.assign(achievementEl.style, {
                position: 'fixed',
                top: '50%',
                left: '50%',
                transform: 'translate(-50%, -50%) scale(0)',
                background: 'rgba(0, 0, 0, 0.9)',
                border: '2px solid #4caf50',
                borderRadius: '16px',
                padding: '20px',
                display: 'flex',
                alignItems: 'center',
                gap: '15px',
                zIndex: '10000',
                transition: 'transform 0.3s ease',
                maxWidth: '400px',
                boxShadow: '0 10px 30px rgba(0, 0, 0, 0.5)',
                color: 'white'
            });
            
            document.body.appendChild(achievementEl);
            
            // Êí≠ÊîæÊàêÂ∞±Èü≥Êïà
            if (window.audioManager) {
                window.audioManager.playSound('achievement');
            }
            
            // ÊòæÁ§∫Âä®Áîª
            setTimeout(() => {
                achievementEl.style.transform = 'translate(-50%, -50%) scale(1)';
            }, 100);
            
            // Ëá™Âä®ÈöêËóè
            setTimeout(() => {
                achievementEl.style.transform = 'translate(-50%, -50%) scale(0)';
                setTimeout(() => {
                    if (document.body.contains(achievementEl)) {
                        document.body.removeChild(achievementEl);
                    }
                }, 300);
            }, 4000);
        };
        
        // ÂàÜ‰∫´ÁªìÊûú
        const shareResults = (stats) => {
            if (!stats) return;
            
            const shareText = `ÊàëÂú®ÈîÆÁõòÊâìÂ≠óÁ´ûÈÄüÊ∏∏Êàè‰∏≠ÂèñÂæó‰∫Ü ${stats.wpm} WPM (${stats.cpm} CPM)ÔºåÂáÜÁ°ÆÁéá ${stats.accuracy}%ÔºÅ‰Ω†ËÉΩË∂ÖË∂äÊàëÂêóÔºü`;
            
            if (navigator.share) {
                // ‰ΩøÁî®ÂéüÁîüÂàÜ‰∫´API
                navigator.share({
                    title: 'ÈîÆÁõòÊâìÂ≠óÁ´ûÈÄüÊ∏∏ÊàèÊàêÁª©',
                    text: shareText,
                    url: window.location.href
                }).catch(console.error);
            } else {
                // Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø
                navigator.clipboard.writeText(shareText).then(() => {
                    showNotification('ÊàêÁª©Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ', 'success');
                }).catch(() => {
                    showNotification('ÂàÜ‰∫´Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂ÊàêÁª©', 'error');
                });
            }
        };
        
        // ÈÄöÁü•ÊòæÁ§∫ (ÁÆÄÂåñÁâàÔºå‰∏éVueÂ∫îÁî®ÁöÑÈÄöÁü•Á≥ªÁªüÈÖçÂêà)
        const showNotification = (message, type = 'info') => {
            // Ëß¶ÂèëVueÂ∫îÁî®ÁöÑÈÄöÁü•Á≥ªÁªü
            const event = new CustomEvent('app-notification', {
                detail: { message, type }
            });
            document.dispatchEvent(event);
        };
        
        // ‰∏ªÈ¢òÂàáÊç¢ - ÂèÇËÄÉÂéüUIManagerÂÆûÁé∞
        const toggleTheme = () => {
            const currentIndex = themes.indexOf(currentTheme.value);
            const nextIndex = (currentIndex + 1) % themes.length;
            
            currentTheme.value = themes[nextIndex];
            applyTheme(currentTheme.value);
            saveThemeSettings();
            
            showNotification(`Â∑≤ÂàáÊç¢Âà∞${getThemeName(currentTheme.value)}‰∏ªÈ¢ò`, 'success');
        };
        
        // Â∫îÁî®‰∏ªÈ¢ò - ÂèÇËÄÉÂéüUIManagerÂÆûÁé∞
        const applyTheme = (theme) => {
            // ÁßªÈô§ÊâÄÊúâ‰∏ªÈ¢òÁ±ª
            document.body.className = document.body.className.replace(/theme-\w+/g, '');
            
            // Ê∑ªÂä†Êñ∞‰∏ªÈ¢òÁ±ª
            document.body.classList.add(`theme-${theme}`);
            
            // Êõ¥Êñ∞‰∏ªÈ¢òÊåâÈíÆÂõæÊ†á
            const themeToggleBtn = document.getElementById('themeToggle');
            if (themeToggleBtn) {
                themeToggleBtn.textContent = themeIcons[theme] || 'üåô';
                themeToggleBtn.title = `ÂΩìÂâç: ${getThemeName(theme)}‰∏ªÈ¢òÔºåÁÇπÂáªÂàáÊç¢`;
            }
            
            console.log(`Â∫îÁî®‰∏ªÈ¢ò: ${theme}`);
        };
        
        // ‰øùÂ≠ò‰∏ªÈ¢òËÆæÁΩÆ
        const saveThemeSettings = () => {
            const settings = Utils.Storage.get('gameSettings', {});
            settings.theme = currentTheme.value;
            Utils.Storage.set('gameSettings', settings);
        };
        
        // Èü≥È¢ëÂàáÊç¢ - ÂèÇËÄÉÂéüUIManagerÂÆûÁé∞
        const toggleAudio = () => {
            if (window.audioManager) {
                window.audioManager.toggleAudio();
            }
            updateAudioButton();
        };
        
        // Êõ¥Êñ∞Èü≥È¢ëÊåâÈíÆ - ÂèÇËÄÉÂéüUIManagerÂÆûÁé∞
        const updateAudioButton = () => {
            const audioToggleBtn = document.getElementById('audioToggle');
            if (!audioToggleBtn || !window.audioManager) return;
            
            const status = window.audioManager.getStatus();
            audioToggleBtn.textContent = status.isEnabled ? 'üîä' : 'üîá';
            audioToggleBtn.title = status.isEnabled ? 'ÂÖ≥Èó≠Èü≥È¢ë' : 'ÂºÄÂêØÈü≥È¢ë';
        };
        
        // ÊâìÂºÄËÆæÁΩÆÊ®°ÊÄÅÊ°Ü
        const openSettings = () => {
            const settingsModal = document.getElementById('settingsModal');
            if (settingsModal) {
                settingsModal.classList.remove('hidden');
                loadCurrentSettings();
                showNotification('ËÆæÁΩÆÈù¢ÊùøÂ∑≤ÊâìÂºÄ', 'info');
            }
        };
        
        // ÂÖ≥Èó≠ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü
        const closeSettings = () => {
            const settingsModal = document.getElementById('settingsModal');
            if (settingsModal) {
                settingsModal.classList.add('hidden');
            }
        };
        
        // Âä†ËΩΩÂΩìÂâçËÆæÁΩÆÂà∞Ê®°ÊÄÅÊ°Ü
        const loadCurrentSettings = () => {
            const settings = Utils.Storage.get('gameSettings', {
                theme: 'dark',
                timeLimit: 60,
                difficulty: 'normal',
                enableSounds: true,
                enableMusic: true,
                highlightErrors: true
            });
            
            // Êõ¥Êñ∞Ë°®ÂçïÂÖÉÁ¥†
            const timeLimitSelect = document.getElementById('timeLimitSelect');
            if (timeLimitSelect) {
                timeLimitSelect.value = settings.timeLimit || 60;
            }
            
            const difficultySelect = document.getElementById('difficultySelect');
            if (difficultySelect) {
                difficultySelect.value = settings.difficulty || 'normal';
            }
            
            const enableSounds = document.getElementById('enableSounds');
            if (enableSounds) {
                enableSounds.checked = settings.enableSounds !== false;
            }
            
            const enableMusic = document.getElementById('enableMusic');
            if (enableMusic) {
                enableMusic.checked = settings.enableMusic !== false;
            }
            
            const highlightErrors = document.getElementById('highlightErrors');
            if (highlightErrors) {
                highlightErrors.checked = settings.highlightErrors !== false;
            }
            
            const themeSelectModal = document.getElementById('themeSelectModal');
            if (themeSelectModal) {
                themeSelectModal.value = settings.theme || 'dark';
            }
        };
        
        // ‰øùÂ≠òËÆæÁΩÆ
        const saveSettings = () => {
            const timeLimitSelect = document.getElementById('timeLimitSelect');
            const difficultySelect = document.getElementById('difficultySelect');
            const enableSounds = document.getElementById('enableSounds');
            const enableMusic = document.getElementById('enableMusic');
            const highlightErrors = document.getElementById('highlightErrors');
            const themeSelectModal = document.getElementById('themeSelectModal');
            
            const settings = {
                theme: themeSelectModal?.value || 'dark',
                timeLimit: parseInt(timeLimitSelect?.value) || 60,
                difficulty: difficultySelect?.value || 'normal',
                enableSounds: enableSounds?.checked !== false,
                enableMusic: enableMusic?.checked !== false,
                highlightErrors: highlightErrors?.checked !== false
            };
            
            Utils.Storage.set('gameSettings', settings);
            
            // Â∫îÁî®‰∏ªÈ¢òËÆæÁΩÆ
            if (settings.theme !== currentTheme.value) {
                currentTheme.value = settings.theme;
                applyTheme(settings.theme);
            }
            
            // Â∫îÁî®Èü≥È¢ëËÆæÁΩÆ
            if (window.audioManager) {
                const audioStatus = window.audioManager.getStatus();
                
                if (settings.enableSounds !== audioStatus.effectsEnabled) {
                    window.audioManager.toggleEffects();
                }
                
                if (settings.enableMusic !== audioStatus.musicEnabled) {
                    window.audioManager.toggleMusic();
                }
                
                updateAudioButton();
            }
            
            closeSettings();
            showNotification('ËÆæÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
            console.log('ËÆæÁΩÆÂ∑≤‰øùÂ≠ò:', settings);
        };
        
        // ÈáçÁΩÆËÆæÁΩÆ
        const resetSettings = () => {
            if (confirm('Á°ÆÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâËÆæÁΩÆ‰∏∫ÈªòËÆ§ÂÄºÂêóÔºü')) {
                const defaultSettings = {
                    theme: 'dark',
                    timeLimit: 60,
                    difficulty: 'normal',
                    enableSounds: true,
                    enableMusic: true,
                    highlightErrors: true
                };
                
                Utils.Storage.set('gameSettings', defaultSettings);
                loadCurrentSettings();
                
                // Â∫îÁî®ÈªòËÆ§‰∏ªÈ¢ò
                currentTheme.value = 'dark';
                applyTheme('dark');
                
                showNotification('ËÆæÁΩÆÂ∑≤ÈáçÁΩÆ‰∏∫ÈªòËÆ§ÂÄº', 'success');
            }
        };
        
        // ÂÖ®Â±èÂàáÊç¢
        const toggleFullscreen = () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.warn('Êó†Ê≥ïËøõÂÖ•ÂÖ®Â±èÊ®°Âºè:', err);
                    showNotification('Êó†Ê≥ïËøõÂÖ•ÂÖ®Â±èÊ®°Âºè', 'warning');
                });
            } else {
                document.exitFullscreen().catch(err => {
                    console.warn('Êó†Ê≥ïÈÄÄÂá∫ÂÖ®Â±èÊ®°Âºè:', err);
                    showNotification('Êó†Ê≥ïÈÄÄÂá∫ÂÖ®Â±èÊ®°Âºè', 'warning');
                });
            }
        };
        
        // ÈîÆÁõòÂø´Êç∑ÈîÆÂ§ÑÁêÜ
        const handleKeyboardShortcuts = (e) => {
            // F11 ÂÖ®Â±èÂàáÊç¢
            if (e.key === 'F11') {
                toggleFullscreen();
                e.preventDefault();
            }
            
            // Esc ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
            if (e.key === 'Escape') {
                const settingsModal = document.getElementById('settingsModal');
                if (settingsModal && !settingsModal.classList.contains('hidden')) {
                    closeSettings();
                    e.preventDefault();
                }
            }
            
            // Èò≤Ê≠¢Êüê‰∫õÂø´Êç∑ÈîÆÁöÑÈªòËÆ§Ë°å‰∏∫
            if (e.ctrlKey) {
                switch (e.key) {
                    case 's': // Ctrl+S
                    case 'p': // Ctrl+P
                        e.preventDefault();
                        break;
                }
            }
        };
        
        // È°µÈù¢ÂèØËßÅÊÄßÂ§ÑÁêÜ
        const handleVisibilityChange = () => {
            if (document.hidden) {
                // È°µÈù¢ÈöêËóèÊó∂ÁöÑÂ§ÑÁêÜ
                const event = new CustomEvent('page-hidden');
                document.dispatchEvent(event);
            } else {
                // È°µÈù¢ÂèØËßÅÊó∂ÁöÑÂ§ÑÁêÜ
                const event = new CustomEvent('page-visible');
                document.dispatchEvent(event);
            }
        };
        
        // ÈîôËØØËÆ∞ÂΩï
        const logError = (type, error) => {
            const errorData = {
                type,
                message: error?.message || String(error),
                stack: error?.stack,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: window.location.href
            };
            
            // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
            const errors = Utils.Storage.get('errorLog', []);
            errors.unshift(errorData);
            
            // ÈôêÂà∂ÈîôËØØÊó•ÂøóÊï∞Èáè
            if (errors.length > 50) {
                errors.splice(50);
            }
            
            Utils.Storage.set('errorLog', errors);
            console.error('ÈîôËØØÂ∑≤ËÆ∞ÂΩï:', errorData);
        };
        
        // Êï∞ÊçÆÂØºÂá∫
        const exportGameData = () => {
            const data = {
                settings: Utils.Storage.get('gameSettings', {}),
                stats: Utils.Storage.get('gameStats', {}),
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `typing-game-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            showNotification('Êï∞ÊçÆÂØºÂá∫ÊàêÂäüÔºÅ', 'success');
        };
        
        // Êï∞ÊçÆÂØºÂÖ•
        const importGameData = (file) => {
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.settings) {
                        Utils.Storage.set('gameSettings', data.settings);
                    }
                    
                    if (data.stats) {
                        Utils.Storage.set('gameStats', data.stats);
                    }
                    
                    showNotification('Êï∞ÊçÆÂØºÂÖ•ÊàêÂäüÔºÅËØ∑Âà∑Êñ∞È°µÈù¢Â∫îÁî®ËÆæÁΩÆ', 'success');
                    
                } catch (error) {
                    console.error('ÂØºÂÖ•Êï∞ÊçÆÂ§±Ë¥•:', error);
                    showNotification('Êï∞ÊçÆÂØºÂÖ•Â§±Ë¥•ÔºåÊñá‰ª∂Ê†ºÂºèÈîôËØØ', 'error');
                }
            };
            
            reader.readAsText(file);
        };
        
        // ÁîüÂëΩÂë®Êúü
        onMounted(() => {
            // Âä†ËΩΩ‰øùÂ≠òÁöÑ‰∏ªÈ¢òËÆæÁΩÆ
            const settings = Utils.Storage.get('gameSettings', {});
            if (settings.theme && themes.includes(settings.theme)) {
                currentTheme.value = settings.theme;
                applyTheme(settings.theme);
            } else {
                // Â¶ÇÊûúÊ≤°Êúâ‰øùÂ≠òÁöÑ‰∏ªÈ¢òÊàñ‰∏ªÈ¢òÊó†ÊïàÔºå‰ΩøÁî®ÈªòËÆ§‰∏ªÈ¢ò
                applyTheme(currentTheme.value);
            }
            
            // ÁªëÂÆöÂè≥‰∏äËßíÊåâÈíÆ‰∫ã‰ª∂
            const themeToggleBtn = document.getElementById('themeToggle');
            const settingsBtn = document.getElementById('settingsBtn');
            const audioToggleBtn = document.getElementById('audioToggle');
            
            if (themeToggleBtn) {
                themeToggleBtn.addEventListener('click', toggleTheme);
                console.log('‚úì ‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆ‰∫ã‰ª∂Â∑≤ÁªëÂÆö');
            }
            
            if (settingsBtn) {
                settingsBtn.addEventListener('click', openSettings);
                console.log('‚úì ËÆæÁΩÆÊåâÈíÆ‰∫ã‰ª∂Â∑≤ÁªëÂÆö');
            }
            
            if (audioToggleBtn) {
                audioToggleBtn.addEventListener('click', toggleAudio);
                console.log('‚úì Èü≥È¢ëÂàáÊç¢ÊåâÈíÆ‰∫ã‰ª∂Â∑≤ÁªëÂÆö');
            }
            
            // ÁªëÂÆöËÆæÁΩÆÊ®°ÊÄÅÊ°Ü‰∫ã‰ª∂
            const closeSettingsBtn = document.getElementById('closeSettings');
            const saveSettingsBtn = document.getElementById('saveSettings');
            const resetSettingsBtn = document.getElementById('resetSettings');
            const settingsModal = document.getElementById('settingsModal');
            
            if (closeSettingsBtn) {
                closeSettingsBtn.addEventListener('click', closeSettings);
            }
            
            if (saveSettingsBtn) {
                saveSettingsBtn.addEventListener('click', saveSettings);
            }
            
            if (resetSettingsBtn) {
                resetSettingsBtn.addEventListener('click', resetSettings);
            }
            
            // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
            if (settingsModal) {
                settingsModal.addEventListener('click', (e) => {
                    if (e.target === settingsModal) {
                        closeSettings();
                    }
                });
            }
            
            // ÁªëÂÆöÂÖ®Â±Ä‰∫ã‰ª∂
            document.addEventListener('keydown', handleKeyboardShortcuts);
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            // ÂÖ®Â±ÄÈîôËØØÂ§ÑÁêÜ
            window.addEventListener('error', (e) => {
                logError('GlobalError', e.error);
            });
            
            window.addEventListener('unhandledrejection', (e) => {
                logError('UnhandledRejection', e.reason);
            });
            
            // ÂàùÂßãÂåñÈü≥È¢ëÊåâÈíÆÁä∂ÊÄÅ
            updateAudioButton();
            
            console.log('üõ†Ô∏è AppUtils Â∑≤ÂàùÂßãÂåñÔºåÊâÄÊúâÊåâÈíÆ‰∫ã‰ª∂Â∑≤ÁªëÂÆö');
            console.log(`üé® ÂΩìÂâç‰∏ªÈ¢ò: ${getThemeName(currentTheme.value)} (${currentTheme.value})`);
        });
        
        onUnmounted(() => {
            // Ê∏ÖÁêÜ‰∫ã‰ª∂ÁõëÂê¨Âô®
            const themeToggleBtn = document.getElementById('themeToggle');
            const settingsBtn = document.getElementById('settingsBtn');
            const audioToggleBtn = document.getElementById('audioToggle');
            
            if (themeToggleBtn) {
                themeToggleBtn.removeEventListener('click', toggleTheme);
            }
            
            if (settingsBtn) {
                settingsBtn.removeEventListener('click', openSettings);
            }
            
            if (audioToggleBtn) {
                audioToggleBtn.removeEventListener('click', toggleAudio);
            }
            
            document.removeEventListener('keydown', handleKeyboardShortcuts);
            document.removeEventListener('visibilitychange', handleVisibilityChange);
        });
        
        return {
            showAchievement,
            shareResults,
            showNotification,
            toggleTheme,
            toggleAudio,
            toggleFullscreen,
            exportGameData,
            importGameData,
            logError
        };
    },
    template: `<div style="display: none;"></div>` // ÈöêËóèÁªÑ‰ª∂ÔºåÂè™Êèê‰æõÂäüËÉΩ
};

// ÂØºÂá∫ÁªÑ‰ª∂
window.AppUtils = AppUtils;
